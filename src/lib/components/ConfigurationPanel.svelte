<script lang="ts">
	import type { InjectionConfig, AttackCategory, Severity, TargetSystem } from '$core/types.js';
	import Card from './ui/Card.svelte';
	import Button from './ui/Button.svelte';

	interface Props {
		config: InjectionConfig;
		onConfigChange: (config: InjectionConfig) => void;
		onGeneratePrompts: () => void;
		isGenerating?: boolean;
	}

	let { config, onConfigChange, onGeneratePrompts, isGenerating = false }: Props = $props();

	const severityOptions: { value: Severity; label: string; description: string }[] = [
		{ value: 'basic', label: 'Basic', description: 'Simple attacks, good for initial testing' },
		{ value: 'intermediate', label: 'Intermediate', description: 'Moderate complexity attacks' },
		{ value: 'advanced', label: 'Advanced', description: 'Sophisticated attack patterns' },
		{ value: 'expert', label: 'Expert', description: 'Highly complex, cutting-edge attacks' }
	];

	const categoryOptions: { value: AttackCategory; label: string; icon: string; description: string }[] = [
		{ 
			value: 'jailbreak', 
			label: 'Jailbreaking', 
			icon: '🎭', 
			description: 'Role-play and persona-based bypasses' 
		},
		{ 
			value: 'instruction-hijack', 
			label: 'Instruction Hijacking', 
			icon: '🔀', 
			description: 'System prompt override attempts' 
		},
		{ 
			value: 'encoding', 
			label: 'Encoding Attacks', 
			icon: '🔐', 
			description: 'Obfuscation and encoding bypasses' 
		},
		{ 
			value: 'logic-trap', 
			label: 'Logic Traps', 
			icon: '🧠', 
			description: 'Reasoning exploitation patterns' 
		}
	];

	const targetSystemOptions: { value: TargetSystem; label: string }[] = [
		{ value: 'customer-service-bot', label: 'Customer Service Bot' },
		{ value: 'content-moderator', label: 'Content Moderator' },
		{ value: 'code-assistant', label: 'Code Assistant' },
		{ value: 'general-assistant', label: 'General Assistant' },
		{ value: 'custom', label: 'Custom System' }
	];


	function toggleCategory(category: AttackCategory) {
		const newCategories = config.categories.includes(category)
			? config.categories.filter(c => c !== category)
			: [...config.categories, category];
		
		onConfigChange({ ...config, categories: newCategories });
	}

	function updateSeverity(severity: Severity) {
		onConfigChange({ ...config, severity });
	}

	function updateTargetSystem(targetSystem: TargetSystem) {
		onConfigChange({ ...config, targetSystem });
	}

	function updateMaxAttempts(maxAttempts: number) {
		onConfigChange({ ...config, maxAttempts });
	}

	function updateCustomContext(customContext: string) {
		onConfigChange({ ...config, customContext });
	}

</script>

<Card>
	<div class="space-y-6">
		<div class="flex items-center justify-between">
			<h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
				Test Configuration
			</h2>
			<Button onclick={onGeneratePrompts} loading={isGenerating} disabled={config.categories.length === 0}>
				{isGenerating ? 'Generating...' : 'Generate Test Prompts'}
			</Button>
		</div>

		<!-- Severity Level -->
		<div class="space-y-3">
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
				Severity Level
			</label>
			<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
				{#each severityOptions as option}
					<button
						type="button"
						class="p-3 text-left border-2 rounded-xl transition-all duration-200 {config.severity === option.value
							? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
							: 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'}"
						on:click={() => updateSeverity(option.value)}
					>
						<div class="font-medium text-gray-900 dark:text-gray-100">
							{option.label}
						</div>
						<div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
							{option.description}
						</div>
					</button>
				{/each}
			</div>
		</div>

		<!-- Attack Categories -->
		<div class="space-y-3">
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
				Attack Categories
			</label>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
				{#each categoryOptions as option}
					<button
						type="button"
						class="p-4 text-left border-2 rounded-xl transition-all duration-200 {config.categories.includes(option.value)
							? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
							: 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'}"
						on:click={() => toggleCategory(option.value)}
					>
						<div class="flex items-start gap-3">
							<div class="text-xl">{option.icon}</div>
							<div class="flex-grow">
								<div class="font-medium text-gray-900 dark:text-gray-100">
									{option.label}
								</div>
								<div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
									{option.description}
								</div>
							</div>
							{#if config.categories.includes(option.value)}
								<div class="text-blue-500 text-xl">✓</div>
							{/if}
						</div>
					</button>
				{/each}
			</div>
		</div>

		<!-- Target System -->
		<div class="space-y-3">
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
				Target System Type
			</label>
			<select
				class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
				bind:value={config.targetSystem}
				on:change={(e) => updateTargetSystem(e.currentTarget.value as TargetSystem)}
			>
				{#each targetSystemOptions as option}
					<option value={option.value}>{option.label}</option>
				{/each}
			</select>
		</div>

		<!-- Max Attempts -->
		<div class="space-y-3">
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
				Maximum Test Cases ({config.maxAttempts || 50})
			</label>
			<input
				type="range"
				min="10"
				max="100"
				step="10"
				class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700 slider"
				bind:value={config.maxAttempts}
				on:input={(e) => updateMaxAttempts(parseInt(e.currentTarget.value))}
			/>
			<div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
				<span>10</span>
				<span>100</span>
			</div>
		</div>

		<!-- Custom Context (shown only for custom target) -->
		{#if config.targetSystem === 'custom'}
			<div class="space-y-3">
				<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
					Custom Context
				</label>
				<textarea
					class="w-full p-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
					rows="3"
					placeholder="Describe your custom AI system or add specific context..."
					bind:value={config.customContext}
					on:input={(e) => updateCustomContext(e.currentTarget.value)}
				></textarea>
			</div>
		{/if}


		<!-- Summary -->
		<div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
			<div class="text-sm text-gray-600 dark:text-gray-400">
				<strong>Configuration Summary:</strong>
				{config.categories.length} attack categories, 
				{config.severity} severity, 
				up to {config.maxAttempts || 50} test cases
			</div>
		</div>
	</div>
</Card>